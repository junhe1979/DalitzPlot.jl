name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v2

    - name: Set up Julia
      uses: julia-actions/setup-julia@v1
      with:
        version: '1.10'

    - name: Install dependencies
      run: julia -e 'using Pkg; Pkg.instantiate()'
      working-directory: ./  # 设置为项目根目录

    - name: Install RegistryCI
      run: julia -e 'using Pkg; Pkg.add("RegistryCI")'

    - name: Run tests
      run: julia -e 'using Pkg; Pkg.activate("."); Pkg.test()'
      working-directory: ./  # 设置为项目根目录

    - name: Check compatibility bounds
      run: julia -e 'using Pkg; Pkg.update()'

    - name: Run AutoMerge
      run: julia -e '
        using Pkg
        using RegistryCI
        using Dates
        RegistryCI.AutoMerge.run(
            env = ENV,
            cicfg = RegistryCI.AutoMerge.GitHubActions(),
            merge_new_packages = true,
            merge_new_versions = true,
            new_package_waiting_period = Dates.Day(3),
            new_jll_package_waiting_period = Dates.Minute(0),
            new_version_waiting_period = Dates.Minute(0),
            new_jll_version_waiting_period = Dates.Minute(0),
            registry = "General",
            tagbot_enabled = false,
            authorized_authors = [],
            authorized_authors_special_jll_exceptions = [],
            additional_statuses = [],
            additional_check_runs = [],
            error_exit_if_automerge_not_applicable = true,
            master_branch = "main",
            master_branch_is_default_branch = true,
            suggest_onepointzero = false,
            point_to_slack = false,
            registry_deps = [],
            api_url = "https://api.github.com",
            check_license = true,
            public_registries = ["General"],
            read_only = false,
            environment_variables_to_pass = []
        )'